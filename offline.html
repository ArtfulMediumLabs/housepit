<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>Housepit</title>

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.17/Tone.js"></script>
</head>
<body>
	<p>Bai-ee_(Thats_My_Sista)_Unreleased</p>
	<button id="play-toggle" disabled>PLAY/STOP</button>
	<button id="download" disabled>DOWNLOAD</button>

	<script type="text/javascript">
        const player = new Tone.Player().toDestination();

		const trackDir = "/audio/Bai-ee_Track/Bai-ee_Bank_1/";

		const parts = [
			{file: "1_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 16, loop: 1},
			{file: "2_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 32, loop: 0},
			{file: "3_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 64, loop: 0},
			{file: "4_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 32, loop: 0},
			{file: "5_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 16, loop: 0},
			{file: "6_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 16, loop: 0},
			{file: "7_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 16, loop: 0},
			{file: "8_Freeze 6-Bai-ee_(Thats_My_Sista)_Unreleased.wav", length : 8, loop: 1}
		];

        const buffers = parts.map(part => new Tone.Buffer({url:trackDir + part.file}));

        Tone.loaded().then(function(){
            console.log("buffers loaded")
            render()
        })

        var totalLength = parts.reduce((sum, { length, loop }) => sum + length * loop, 0)

        function render() {
            const renderingPromise = Tone.Offline(({ transport }) => {
                transport.bpm.value = 120;

                var playhead = 0;
                buffers.forEach( (buffer, i) => {
                    if (parts[i].loop == 0) { return }

                    var partPlayer = new Tone.Player(buffer)
                    partPlayer.loop = parts[i].loop > 1;
                    var loopLength = parts[i].length * parts[i].loop;
                    partPlayer.toDestination().sync().start(playhead + "m").stop(playhead + loopLength + "m");
                    playhead += loopLength
                });

                transport.start();
            }, Tone.Time(totalLength + "m"))

            renderingPromise.then(buffer => {
                console.log("rendering complete")
                player.buffer = buffer
            });
            
	    	renderingPromise.then(() => document.querySelector("#play-toggle").disabled = false);
            renderingPromise.then(() => document.querySelector("#download").disabled = false);
        }

		document.querySelector("#play-toggle").onclick = function() {
			Tone.start(); 
			if (player.state == "started") {
				player.stop()
			} else {
				player.start()
			}
		}

        document.querySelector("#download").onclick = function() {
            console.log("start download")
		}
	</script>
</body>
</html>
